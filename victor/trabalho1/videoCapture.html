<html>

<head>
<title>MATA65 - Computação Gráfica</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8">

<script id="shader-vs" type="x-shader/x-vertex">
	attribute vec3 aVertexPosition;
	attribute vec2 aVertexTexture;
		
	varying vec2 vTextureCoord;
	
	void main(void) {
		
		gl_Position = vec4(aVertexPosition, 1.0);
		vTextureCoord = aVertexTexture;
	}
</script>

<script id="shader-fs" type="x-shader/x-fragment">
	precision mediump float;
		
	uniform sampler2D uSampler;

	/*Tamanho da imagem*/
	uniform float luz;
	uniform float sat;
	uniform float cont;
	uniform float nit;
	uniform int   at;
	uniform vec2 uPixelSize;
	
	varying vec2 vTextureCoord;
	
	
	float maxM(float r, float g, float b){
		if((r >= g) && (r >= b)){
			return r;
		}

		if((g >= r) && (g >= b)){
			return g;
		}

		if((b >= g) && (b >= r)){
			return b;
		}
	}

	float minM(float r, float g, float b){
		if((r <= g) && (r <= b)){
			return r;
		}

		if((g <= r) && (g <= b)){
			return g;
		}

		if((b <= g) && (b <= r)){
			return b;
		}
	}


	vec4 convertRGBtoHSL( vec4 col , float luz, float sate)
	{
	    float red   = col.r;
	    float green = col.g;
	    float blue  = col.b;

	    float minc  = minM( col.r, col.g, col.b );
	    float maxc  = maxM( col.r, col.g, col.b );
	    float delta = maxc - minc;

	    float lum = (minc + maxc) * 0.5;
	    float sat = 0.0;
	    float hue = 0.0;

	    if (lum > 0.0 && lum < 1.0) {
	        float mul = (lum < 0.5)  ?  (lum)  :  (1.0-lum);
	        sat = delta / (mul * 2.0);
	    }

	    vec3 masks = vec3(
	        (maxc == red   && maxc != green) ? 1.0 : 0.0,
	        (maxc == green && maxc != blue)  ? 1.0 : 0.0,
	        (maxc == blue  && maxc != red)   ? 1.0 : 0.0
	    );

	    vec3 adds = vec3(
	              ((green - blue ) / delta),
	        2.0 + ((blue  - red  ) / delta),
	        4.0 + ((red   - green) / delta)
	    );

	    float deltaGtz = (delta > 0.0) ? 1.0 : 0.0;

	    hue += dot( adds, masks );
	    hue *= deltaGtz;
	    hue /= 6.0;

	    if (hue < 0.0)
	        hue += 1.0;

	    return vec4( hue, sat+sate, lum+luz, col.a );
	}
	vec4 convertHSLtoRGB( vec4 col)
	{
	    const float onethird = 1.0 / 3.0;
	    const float twothird = 2.0 / 3.0;
	    const float rcpsixth = 6.0;

	    float hue = col.x;
	    float sat = col.y;
	    float lum = col.z;

	    vec3 xt = vec3(
	        rcpsixth * (hue - twothird),
	        0.0,
	        rcpsixth * (1.0 - hue)
	    );

	    if (hue < twothird) {
	        xt.r = 0.0;
	        xt.g = rcpsixth * (twothird - hue);
	        xt.b = rcpsixth * (hue      - onethird);
	    } 

	    if (hue < onethird) {
	        xt.r = rcpsixth * (onethird - hue);
	        xt.g = rcpsixth * hue;
	        xt.b = 0.0;
	    }

	    xt = min( xt, 1.0 );

	    float sat2   =  2.0 * sat;
	    float satinv =  1.0 - sat;
	    float luminv =  1.0 - lum;
	    float lum2m1 = (2.0 * lum) - 1.0;
	    vec3  ct     = (sat2 * xt) + satinv;

	    vec3 rgb;
	    if (lum >= 0.5)
	         rgb = (luminv * ct) + lum2m1;
	    else rgb =  lum    * ct;

	    return vec4( rgb, col.a );
	}
	void main(void) {
		if(at == 0){
			vec4 c = texture2D(uSampler, vTextureCoord);
			
			vec4 cN = convertHSLtoRGB(convertRGBtoHSL(c,luz,sat));
			gl_FragColor = vec4(pow(cN.r,cont),pow(cN.g,cont),pow(cN.b,cont),1.0);
			
           }else{
                       float n = 8.0;
           
                       vec2 px = uPixelSize;
                       //LaPlaciano
                       vec4 soma = texture2D(uSampler, vTextureCoord + px * vec2 (0, 0)) * -4.0 +
                       texture2D(uSampler, vTextureCoord + px * vec2(-1, 0)) * 1.0 + 
                       texture2D(uSampler, vTextureCoord + px * vec2( 1, 0)) * 1.0 +
                       texture2D(uSampler, vTextureCoord + px * vec2( 0,-1)) * 1.0 + 
                       texture2D(uSampler, vTextureCoord + px * vec2( 1, 0)) * 1.0; 
           
                       soma += vec4(1.5,1.5,1.5,1.5);
           
                       n = nit;
           
                       //Isotrópico 45°
                       vec4 s = texture2D(uSampler, vTextureCoord + px * vec2( 0, 0)) + 
                       texture2D(uSampler, vTextureCoord + px * vec2(-1, 0)) + 
                       texture2D(uSampler, vTextureCoord + px * vec2( 1, 0)) + 
                       texture2D(uSampler, vTextureCoord + px * vec2( 0,1)) + 
                       texture2D(uSampler, vTextureCoord + px * vec2( 1, 1)) +
                       texture2D(uSampler, vTextureCoord + px * vec2( -1, 1)) + 
                       texture2D(uSampler, vTextureCoord + px * vec2(0,-1)) +
                       texture2D(uSampler, vTextureCoord + px * vec2(-1, -1)) +
                        texture2D(uSampler, vTextureCoord + px * vec2( 0, -1)) ;
           
                       soma =  texture2D(uSampler, vTextureCoord + px * vec2(0, 0)) * -8.0 +
                       texture2D(uSampler, vTextureCoord + px * vec2(-1, 0)) * 1.0 + 
                       texture2D(uSampler, vTextureCoord + px * vec2( 1, 0)) * 1.0 +
                       texture2D(uSampler, vTextureCoord + px * vec2( 0,-1)) * 1.0 + 
                       texture2D(uSampler, vTextureCoord + px * vec2( 1, 0)) * 1.0 +
                       texture2D(uSampler, vTextureCoord + px * vec2(-1,-1)) * 1.0 + 
                       texture2D(uSampler, vTextureCoord + px * vec2( 1,-1)) * 1.0 + 
                       texture2D(uSampler, vTextureCoord + px * vec2( 1, 1)) * 1.0 + 
                       texture2D(uSampler, vTextureCoord + px * vec2(-1, 1)) * 1.0; 
           
                       vec3 rgb = ((s/8.0+soma) / n).rgb;
                       gl_FragColor = vec4(rgb, 1.0);}
	}
</script>

<script type="text/javascript" src="../../lib/webgl-utils.js"></script>
<script type="text/javascript" src="../../lib/shaders.js"></script>
<script type="text/javascript" src="videoCapture.js"></script>

</head>

<body onload="webGLStart();">
    <h1>Trabalho</h1><br />
    <p>Captura e manipulação de video em WebGL.</p>
    <br/>
    <div id="output">Brilho: 0.1</div><br\><br\>
    <input type="range" id="pSize" min="-100.0" max="100.0" step="0.1" value="0.1" onchange="changePSize(this.value)"><br/><br/>
    <div id="outputs">Saturação: 0.1</div><br\><br\>
    <input type="range" id="pSat" min="-100.0" max="100.0" step="0.1" value="0.1" onchange="changePSat(this.value)"><br/><br/>
    <div id="output"> </div>
     <div id="outputc">Contraste: 0.1</div><br\><br\>
    <input type="range" id="pCont" min="0.0" max="5.0" step="0.1" value="1.8" onchange="changePCont(this.value)"><br/><br/>
    <div id="outputn">Nitidez: 0.1</div><br\><br\>
    <input type="checkbox" id="check" name="Ativar" value="0" onchange="ativarRange(this.value)">
     <input type="range" id="pNit" min="0.0" max="5.0" step="0.1" value="1.0" style="visibility:hidden" onchange="changePNit(this.value)"><br/><br/>
    <div id="output"> </div>
    <br/>
	<canvas id="videoGL" width="320" height="240" style="visibility: visible;"></canvas>
	<video id="monitor" autoplay width="320" height="240" style="visibility: visible;"></video>
	<canvas id="videoImage" width="256" height="256" style="visibility: hidden;"></canvas>
</body>

</html>
